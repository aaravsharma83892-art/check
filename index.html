<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Auto Marriage Portal Final</title>
    <style>
        :root { --primary-color: #075e54; --secondary-color: #25d366; --accent-color: #34b7f1; --bg-color: #ece5dd; --card-bg: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); margin: 0; padding: 10px; color: #333; }
        .form-container { background: var(--card-bg); padding: 20px; border-radius: 15px; max-width: 500px; margin: 10px auto; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .header { text-align: center; border-bottom: 3px solid var(--secondary-color); margin-bottom: 25px; padding-bottom: 10px; }
        .section-title { background: linear-gradient(90deg, var(--primary-color), var(--accent-color)); padding: 12px; margin: 25px 0 15px 0; border-radius: 8px; color: white; font-weight: bold; font-size: 14px; }
        .form-group { margin-bottom: 18px; }
        label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--primary-color); font-size: 14px; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        
        .date-wrapper { display: flex; gap: 5px; align-items: center; }
        .cal-btn { 
            background: var(--bg-color); border: 2px solid #ddd; border-radius: 10px; 
            width: 50px; height: 46px; font-size: 20px; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; padding: 0;
        }
        .cal-btn:hover { background: #ddd; }

        .ai-panel { background: #f0f7f4; border: 2px dashed var(--accent-color); padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; }
        .btn-row { display: flex; gap: 10px; justify-content: center; }
        .scan-btn { background: var(--accent-color); color: white; border: none; padding: 12px; border-radius: 25px; cursor: pointer; font-weight: bold; flex: 1; font-size: 13px; }
        .loader { display: none; border: 3px solid #f3f3f3; border-top: 3px solid var(--accent-color); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-msg { font-size: 11px; display: block; margin-top: 8px; font-weight: bold; color: #666; }
        .manual-input { display: none; margin-top: 10px; }
        button#previewBtn { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 50px; cursor: pointer; font-size: 1.1rem; font-weight: bold; margin-top: 20px; }
        
        /* CONFIRMATION MODAL */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); align-items: center; justify-content: center; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 15px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 10px; color: var(--primary-color); }
        .review-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; border-bottom: 1px solid #f0f0f0; padding-bottom: 4px; }
        .review-label { font-weight: bold; color: #555; width: 40%; }
        .review-val { text-align: right; width: 60%; color: #000; font-weight: 500; }
        .modal-actions { margin-top: 20px; display: flex; gap: 10px; }
        .btn-cancel { background: #888; color: white; border: none; padding: 12px; border-radius: 8px; flex: 1; font-weight: bold; cursor:pointer;}
        .btn-confirm { background: var(--secondary-color); color: white; border: none; padding: 12px; border-radius: 8px; flex: 1; font-weight: bold; cursor:pointer;}
    </style>
</head>
<body>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">Confirm Details</div>
        <div id="reviewContent"></div>
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal()">Edit</button>
            <button class="btn-confirm" onclick="finalUpload()">CONFIRM & UPLOAD</button>
        </div>
    </div>
</div>

<div class="form-container">
    <div class="header">
        <h2>Marriage Registration</h2>
        <p style="font-size: 12px; color: #666;">Final Version</p>
    </div>

    <form id="marriageForm">
        <div class="section-title">‚ôÇ BOY'S INFORMATION (Min 21 Years)</div>
        <div class="ai-panel">
            <div id="boyLoader" class="loader"></div>
            <div class="btn-row">
                <button type="button" class="scan-btn" onclick="document.getElementById('boyFront').click()">üì∑ Scan Front</button>
                <button type="button" class="scan-btn" style="background:#555" onclick="document.getElementById('boyBack').click()">üì∑ Scan Back</button>
            </div>
            <input type="file" id="boyFront" accept="image/*" style="display:none" onchange="processAI(this, 'boy', 'front')">
            <input type="file" id="boyBack" accept="image/*" style="display:none" onchange="processAI(this, 'boy', 'back')">
            <span id="boyStatus" class="status-msg">Scan ID to Auto-Fill</span>
        </div>
        <div class="form-group"><label>Boy Name</label><input type="text" id="boyName" required></div>
        <div class="form-group"><label>Boy Mother</label><input type="text" id="boyMother" required></div>
        <div class="form-group"><label>Boy Father</label><input type="text" id="boyFather" required></div>
        <div class="form-group">
            <label>Boy DOB (DD/MM/YYYY)</label>
            <div class="date-wrapper">
                <input type="text" id="boyDob" placeholder="DD/MM/YYYY" maxlength="10" required>
                <button type="button" class="cal-btn" onclick="openPicker('boyPicker')">üìÖ</button>
            </div>
            <input type="date" id="boyPicker" style="height:0; width:0; opacity:0; padding:0; border:none; position:absolute;" onchange="syncDate('boyPicker', 'boyDob')">
        </div>
        <div class="form-group"><label>Boy Address</label><textarea id="boyAddress" rows="2" required></textarea></div>
        <div class="form-group"><label>Boy Pincode</label><input type="tel" id="boyPincode" pattern="\d{6}" maxlength="6" placeholder="110096" required></div>

        <div class="section-title">‚ôÄ GIRL'S INFORMATION (Min 18 Years)</div>
        <div class="ai-panel">
            <div id="girlLoader" class="loader"></div>
            <div class="btn-row">
                <button type="button" class="scan-btn" onclick="document.getElementById('girlFront').click()">üì∑ Scan Front</button>
                <button type="button" class="scan-btn" style="background:#555" onclick="document.getElementById('girlBack').click()">üì∑ Scan Back</button>
            </div>
            <input type="file" id="girlFront" accept="image/*" style="display:none" onchange="processAI(this, 'girl', 'front')">
            <input type="file" id="girlBack" accept="image/*" style="display:none" onchange="processAI(this, 'girl', 'back')">
            <span id="girlStatus" class="status-msg">Scan ID to Auto-Fill</span>
        </div>
        <div class="form-group"><label>Girl Name</label><input type="text" id="girlName" required></div>
        <div class="form-group"><label>Girl Mother</label><input type="text" id="girlMother" required></div>
        <div class="form-group"><label>Girl Father</label><input type="text" id="girlFather" required></div>
        <div class="form-group">
            <label>Girl DOB (DD/MM/YYYY)</label>
            <div class="date-wrapper">
                <input type="text" id="girlDob" placeholder="DD/MM/YYYY" maxlength="10" required>
                <button type="button" class="cal-btn" onclick="openPicker('girlPicker')">üìÖ</button>
            </div>
            <input type="date" id="girlPicker" style="height:0; width:0; opacity:0; padding:0; border:none; position:absolute;" onchange="syncDate('girlPicker', 'girlDob')">
        </div>
        <div class="form-group"><label>Girl Address</label><textarea id="girlAddress" rows="2" required></textarea></div>
        <div class="form-group"><label>Girl Pincode</label><input type="tel" id="girlPincode" pattern="\d{6}" maxlength="6" placeholder="110096" required></div>

        <div class="section-title">üíç MARRIAGE DETAILS</div>
        <div class="form-group">
            <label>Marriage Center</label>
            <select id="centerSelect" onchange="toggleManual('centerSelect', 'manualCenterDiv', 'manualCenterName')" required>
                <option value="">-- Select Center --</option>
                <option value="Naitik Vaidik Sanskar Samiti Regd. Gandhi Nagar, Ghaziabad">Naitik Vaidik Sanskar Samiti</option>
                <option value="Moti Mahal Masjid, Kella Bhatta, Ghaziabad">Moti Mahal Masjid</option>
                <option value="Arya Samaj Vivah Uthan Kendra, Old Vijay Nagar, Ghaziabad">Arya Samaj</option>
                <option value="Manual">‚úé Manual Fill</option>
            </select>
            <div id="manualCenterDiv" class="manual-input"><input type="text" id="manualCenterName" placeholder="Center Name"></div>
        </div>
        <div class="form-group">
            <label>Marriage Date (DD/MM/YYYY)</label>
            <div class="date-wrapper">
                <input type="text" id="marriageDate" placeholder="DD/MM/YYYY" maxlength="10" required>
                <button type="button" class="cal-btn" onclick="openPicker('marriagePicker')">üìÖ</button>
            </div>
            <input type="date" id="marriagePicker" style="height:0; width:0; opacity:0; padding:0; border:none; position:absolute;" onchange="syncDate('marriagePicker', 'marriageDate')">
        </div>

        <div class="section-title">üë• WITNESSES</div>
        <div class="form-group">
            <label>Witness 1 Name</label>
            <select id="w1Select" onchange="handleWitnessChange(1)" required>
                <option value="">-- Select Witness 1 --</option>
                <option value="Vipin Tyagi">Vipin Tyagi</option>
                <option value="Mohd Furqan">Mohd Furqan</option>
                <option value="Narayan">Narayan</option>
                <option value="Manual">‚úé Manual Fill</option>
            </select>
            <div id="manualW1Div" class="manual-input"><input type="text" id="manualW1Name" placeholder="Name"></div>
        </div>
        <div class="form-group"><label>Witness 1 Address</label><textarea id="w1Address" rows="2" required></textarea></div>

        <div class="form-group">
            <label>Witness 2 Name</label>
            <select id="w2Select" onchange="handleWitnessChange(2)" required>
                <option value="">-- Select Witness 2 --</option>
                <option value="Sangeeta Kumar">Sangeeta Kumar</option>
                <option value="Soniya Soni">Soniya Soni</option>
                <option value="VIPIN KUMAR">VIPIN KUMAR</option>
                <option value="Bittu">Bittu</option>
                <option value="Manual">‚úé Manual Fill</option>
            </select>
            <div id="manualW2Div" class="manual-input"><input type="text" id="manualW2Name" placeholder="Name"></div>
        </div>
        <div class="form-group"><label>Witness 2 Address</label><textarea id="w2Address" rows="2" required></textarea></div>

        <button type="button" id="previewBtn" onclick="openConfirmation()">REVIEW & SUBMIT</button>
    </form>
    <div id="finalStatus" style="text-align:center; padding:10px; font-weight:bold;"></div>
</div>

<script>
    // Change this line in your script
    const GROQ_API_KEY = "__SECRET_GROQ_KEY__";
    // YOUR NEW WEB APP URL
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzO1OigRWuZCX-83hIU7kBmhQHwzXtdKZ-IdVZbTIJmfilRaacqIzoeRdswRlOVVix40g/exec";
    const MODEL_ID = "meta-llama/llama-4-maverick-17b-128e-instruct";

    const ADDRESSES = {
        "Vipin Tyagi": "H No Ff25, Gali No 7, Budh Bazar Vijay Nagar, Sain Vihar, Ghaziabad, Uttar Pradesh 201001",
        "Mohd Furqan": "House No 939, Kaila Bhatta, Ghaziabad, Uttar Pradesh 201001",
        "Narayan": "Rasoolpur Gujran, Shamli, Rasulpur Gujran, Uttar Pradesh 247775",
        "Sangeeta Kumar": "House No 136 Loni Ghaziabad 201102",
        "Soniya Soni": "House Number A 1, Karawal Nagar, Delhi 110094",
        "VIPIN KUMAR": "165 NEW VIKAS NAGAR LONI GHAZIABAD 201102",
        "Bittu": "H No 45/3, Shanti Vihar, Karhal, Mainpuri, Uttar Pradesh 205264"
    };

    let pendingPayload = null;

    function getMaxDate(yearsAgo) {
        const d = new Date();
        d.setFullYear(d.getFullYear() - yearsAgo);
        return d.toISOString().split('T')[0];
    }

    window.onload = function() {
        document.getElementById('boyPicker').setAttribute("max", getMaxDate(21));
        document.getElementById('girlPicker').setAttribute("max", getMaxDate(18));
    };

    function openPicker(id) { try { document.getElementById(id).showPicker(); } catch (e) { document.getElementById(id).click(); } }
    function syncDate(pid, tid) { const v = document.getElementById(pid).value; if(v) { const [y,m,d]=v.split('-'); document.getElementById(tid).value=`${d}/${m}/${y}`; } }
    const clean = (str) => str ? str.replace(/[~!@#$%^&*()_+<>?:";'{}|\[\]`\-=]/g, "").trim() : "";

    const formatDate = (input) => {
        let v = input.value.replace(/\D/g, '').slice(0, 8);
        if (v.length >= 5) input.value = `${v.slice(0, 2)}/${v.slice(2, 4)}/${v.slice(4)}`;
        else if (v.length >= 3) input.value = `${v.slice(0, 2)}/${v.slice(2)}`;
        else input.value = v;
    };
    ['boyDob', 'girlDob', 'marriageDate'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => formatDate(e.target));
    });

    function toggleManual(selId, divId, inpId) {
        const sel = document.getElementById(selId);
        const div = document.getElementById(divId);
        const inp = document.getElementById(inpId);
        if (sel.value === "Manual") { div.style.display = 'block'; inp.required = true; } 
        else { div.style.display = 'none'; inp.required = false; }
    }

    function handleWitnessChange(n) {
        const sel = document.getElementById(`w${n}Select`);
        const addr = document.getElementById(`w${n}Address`);
        toggleManual(`w${n}Select`, `manualW${n}Div`, `manualW${n}Name`);
        if (ADDRESSES[sel.value]) addr.value = clean(ADDRESSES[sel.value]); 
    }

    async function processAI(input, prefix, side) {
        const status = document.getElementById(prefix + 'Status');
        const loader = document.getElementById(prefix + 'Loader');
        if (!input.files[0] || !GROQ_API_KEY) return;

        status.innerText = `‚è≥ Processing ${side.toUpperCase()}...`;
        status.style.color = "#34b7f1";
        loader.style.display = "block";

        const sideInstructions = side === 'front' 
            ? "Extract ONLY: name, dob (DD/MM/YYYY), and father_name. Ignore address." 
            : "Extract ONLY: address, pincode, and father_name. Ignore name and dob.";

        try {
            const b64 = await resizeImg(input.files[0]);
            const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: MODEL_ID,
                    messages: [{ role: "user", content: [{ type: "text", text: `Return JSON ONLY for Indian ID. ${sideInstructions} Do not return null.` }, { type: "image_url", image_url: { url: b64 } }] }],
                    response_format: { type: "json_object" },
                    temperature: 0
                })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error?.message || "Scan Failed");
            const info = JSON.parse(result.choices[0].message.content);
            const setVal = (id, val) => { const el = document.getElementById(id); const c = clean(val); if(c) { if (el.value.trim() === "") el.value = c; } };

            if (side === 'front') {
                setVal(prefix + 'Name', info.name || info.Name);
                setVal(prefix + 'Father', info.father_name || info.father);
                setVal(prefix + 'Dob', info.dob || info.DOB);
            } else {
                setVal(prefix + 'Address', info.address || info.Address);
                setVal(prefix + 'Pincode', info.pincode || info.Pincode);
            }
            status.innerText = `‚úÖ ${side.toUpperCase()} Success`;
            status.style.color = "green";
        } catch (e) {
            console.error(e);
            status.innerText = "‚ùå Scan Error: Check Console";
            status.style.color = "red";
        } finally { loader.style.display = "none"; }
    }

    // REVIEW STEP
    function openConfirmation() {
        const form = document.getElementById('marriageForm');
        if (!form.checkValidity()) { form.reportValidity(); return; }

        const getVal = (sId, mId) => document.getElementById(sId).value === "Manual" ? document.getElementById(mId).value : document.getElementById(sId).value;

        // EXACT KEYS TO MATCH APP SCRIPT
        pendingPayload = {
            "Boy Name": clean(document.getElementById('boyName').value),
            "Boy Mother": clean(document.getElementById('boyMother').value),
            "Boy Father": clean(document.getElementById('boyFather').value),
            "Boy DOB": document.getElementById('boyDob').value, 
            "Boy Address": clean(document.getElementById('boyAddress').value),
            "Boy Pincode": clean(document.getElementById('boyPincode').value),
            "Girl Name": clean(document.getElementById('girlName').value),
            "Girl Mother": clean(document.getElementById('girlMother').value),
            "Girl Father": clean(document.getElementById('girlFather').value),
            "Girl DOB": document.getElementById('girlDob').value,
            "Girl Address": clean(document.getElementById('girlAddress').value),
            "Girl Pincode": clean(document.getElementById('girlPincode').value),
            "Marriage Center": clean(getVal('centerSelect', 'manualCenterName')),
            "Marriage Date": document.getElementById('marriageDate').value,
            "Witness 1 Name": clean(getVal('w1Select', 'manualW1Name')),
            "Witness 1 Address": clean(document.getElementById('w1Address').value),
            "Witness 2 Name": clean(getVal('w2Select', 'manualW2Name')),
            "Witness 2 Address": clean(document.getElementById('w2Address').value)
        };

        let html = '';
        for (const [key, value] of Object.entries(pendingPayload)) {
            html += `<div class="review-row"><span class="review-label">${key}</span><span class="review-val">${value}</span></div>`;
        }
        document.getElementById('reviewContent').innerHTML = html;
        document.getElementById('confirmModal').style.display = 'flex';
    }

    function closeModal() { document.getElementById('confirmModal').style.display = 'none'; }

    function finalUpload() {
        closeModal();
        const stat = document.getElementById('finalStatus');
        const btn = document.getElementById('previewBtn');
        stat.innerText = "‚è≥ Uploading Data...";
        btn.disabled = true;

        fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(pendingPayload) })
        .then(() => { stat.innerText = "‚úÖ DATA SAVED SUCCESSFULLY!"; stat.style.color="green"; document.getElementById('marriageForm').reset(); })
        .catch(() => { stat.innerText = "‚ùå FAILED"; stat.style.color="red"; })
        .finally(() => { btn.disabled = false; });
    }

    function resizeImg(file) {
        return new Promise(r => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const scale = 800 / img.width;
                    canvas.width = 800; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    r(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    }
</script>
</body>

</html>


